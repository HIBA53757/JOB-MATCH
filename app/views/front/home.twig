{% extends "layouts/layout_front.html.twig" %}

{% block content %}
	<!-- HERO / SEARCH -->
	<section class="relative mb-12">
		<div class="bg-gradient-to-br from-purple-700 via-blue-600 to-indigo-700 rounded-3xl p-10 text-white shadow-2xl">
			<h1 class="text-4xl font-extrabold mb-3">Trouvez votre stage ou emploi</h1>
			<p class="text-lg opacity-90 mb-8">Parcourez les offres exclusives du réseau YouCode</p>

			<!-- Search bar -->
			<form id="searchForm" class="max-w-3xl">
				<div
					class="relative flex flex-col md:flex-row gap-4">
					<!-- KEYWORD -->
					<div class="relative flex-1">
						<span class="absolute inset-y-0 left-4 flex items-center text-gray-400">
							<i class="fas fa-search"></i>
						</span>
						<input type="text" name="keyword" id="keyword" placeholder="Titre, compétence, entreprise..." class="w-full pl-12 pr-4 py-4 rounded-xl text-gray-800 bg-white/95 backdrop-blur focus:outline-none focus:ring-2 focus:ring-purple-400 transition">
					</div>
				</div>
				<p class="text-sm mt-3 opacity-80">La recherche se lance automatiquement pendant la saisie</p>
			</form>
		</div>
	</section>

	<!-- CONTENT -->
	<div
		class="flex flex-col md:flex-row gap-10">
		<!-- FILTERS -->
		<aside class="w-full md:w-1/4">
			<div class="bg-white/80 backdrop-blur p-6 rounded-2xl shadow-lg sticky top-6 space-y-4">
				<h3 class="font-bold text-lg mb-2 text-purple-700">Filtrer par</h3>

				<!-- Company Filter -->
				<div>
					<label for="companyFilter" class="block text-sm font-medium text-gray-700 mb-2">Entreprise</label>
					<select id="companyFilter" class="w-full py-3 px-4 rounded-xl text-gray-800 bg-white/95 backdrop-blur focus:outline-none focus:ring-2 focus:ring-purple-400 transition">
						<option value="">Toutes les entreprises</option>
						{% set seenCompanies = [] %}
						{% for annonce in annonces %}
							{% if annonce.company_name not in seenCompanies %}
								{% set seenCompanies = seenCompanies|merge([annonce.company_name]) %}
								<option value="{{ annonce.company_name }}">{{ annonce.company_name }}</option>
							{% endif %}
						{% endfor %}
					</select>
				</div>

				<!-- Contract Filter -->
				<div>
					<label for="contractFilter" class="block text-sm font-medium text-gray-700 mb-2">Type de contrat</label>
					<select id="contractFilter" class="w-full py-3 px-4 rounded-xl text-gray-800 bg-white/95 backdrop-blur focus:outline-none focus:ring-2 focus:ring-purple-400 transition">
						<option value="">Tous les contrats</option>
						{% set seenContracts = [] %}
						{% for annonce in annonces %}
							{% if annonce.contract_type not in seenContracts %}
								{% set seenContracts = seenContracts|merge([annonce.contract_type]) %}
								<option value="{{ annonce.contract_type }}">{{ annonce.contract_type }}</option>
							{% endif %}
						{% endfor %}
					</select>
				</div>
			</div>
		</aside>

		<!-- JOB LIST -->
		<div class="w-full md:w-3/4 space-y-6" id="jobsContainer">
			{% for annonce in annonces %}
				<article class="group bg-white p-6 rounded-2xl border border-gray-100 shadow hover:shadow-xl transition flex flex-col md:flex-row justify-between gap-6">
					<div class="flex gap-5">
						<img src="/uploads/images/{{ annonce.image }}" class="w-16 h-16 rounded-xl object-cover shadow" alt="Logo {{ annonce.company_name }}">

						<div class="flex-1">
							<h2 class="text-xl font-bold text-gray-800 group-hover:text-purple-600 transition">
								<form method="POST" action="/user/companyDetails">
									<input type="hidden" name="company_id" value="{{ annonce.company_real_id }}">
									<button class="text-left">{{ annonce.title }}</button>
								</form>
							</h2>

							<div class="text-sm text-gray-500 mt-2 flex flex-wrap gap-3">
								<span>
									<i class="fas fa-building"></i>
									{{ annonce.company_name }}</span>
								<span>
									<i class="fas fa-map-marker-alt"></i>
									{{ annonce.location }}</span>
								<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-xs">{{ annonce.contract_type }}</span>
							</div>

							<p class="text-gray-600 text-sm mt-3 line-clamp-2">{{ annonce.description }}</p>

							<div class="mt-4 flex gap-2 flex-wrap">
								{% for skill in annonce.skills|split(',') %}
									<span class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-full">{{ skill }}</span>
								{% endfor %}
							</div>
						</div>
					</div>

					<div class="text-right">
						<span class="text-xs text-gray-400 block mb-3">{{ annonce.created_at|date("d/m/Y") }}</span>
						<form method="POST" action="/user/postDetails">
							<input type="hidden" name="annonce_id" value="{{ annonce.id }}">
							<button class="inline-flex items-center gap-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white px-5 py-2 rounded-xl text-sm font-semibold hover:opacity-90 transition">
								Voir détails
								<i class="fas fa-arrow-right text-xs"></i>
							</button>
						</form>
					</div>
				</article>
			{% else %}
				<p class="text-gray-600">Aucune annonce active pour le moment.</p>
			{% endfor %}
		</div>
	</div>


<script>
const companyFilter  = document.getElementById('companyFilter');
const contractFilter = document.getElementById('contractFilter');
const jobsContainer  = document.getElementById('jobsContainer');

function filterJobs() {
    const company  = companyFilter.value;
    const contract = contractFilter.value;

   fetch(`/user/filter-annonces?company=${company}&contract=${contract}`)
    .then(res => res.text())   
    .then(html => {
        jobsContainer.innerHTML = html;
    });
}

companyFilter.addEventListener('change', filterJobs);
contractFilter.addEventListener('change', filterJobs);
</script>


{% endblock %}
